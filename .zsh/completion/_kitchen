#compdef kitchen

local -a _commands
_commands=(
  "console:Kitchen console!"
  "converge:Converge one or more instances"
  "create:Create one or more instances"
  "destroy:Destroy one or more instances"
  "help:Describe available commands or one specific command"
  "init:Adds some configuration to your cookbook so Kitchen can rock"
  "list:List all instances"
  "login:Login to an instance"
  "setup:Setup one or more instances"
  "test:Test one or more instances"
  "verify:Verify one or more instances"
  "version:Print Kitchen's version information"
)

_arguments \
  "1: :->cmds" \
  "2: :->instances" \
  "*:: :->options" && ret=0

# The sed at the end of these is to strip color chars from kitchen's output
_kitchen_all_instances() {
  kitchen list | grep -v Instance | awk '{print $1}' | sed 's/[^A-Za-z0-9\-].*$//g'
}

_kitchen_created_instances() {
  kitchen list | grep -v -e Instance -e '<Not Created>' | awk '{print $1}' | sed 's/[^A-Za-z0-9\-].*$//g'
}

case $state in
  cmds)
    _describe -t commands "kitchen command" _commands
    return
  ;;
  instances)
    case $line[1] in
      (converge|create|list|setup|test|verify)
        compadd $(_kitchen_all_instances)
      ;;
      (destroy|login)
        compadd $(_kitchen_created_instances)
      ;;
    esac
    ;;
  #options)
  #  echo "x$line[1]x"
  #  case $line[1] in
  #    converge)
  #      _arguments \
  #        '(--parallel)--parallel[Perform action against all matching instances in parallel]' \
  #        '(--log-level)--log-level[Set the log level (debug, info, warn, error, fatal)]'
  #  esac
esac
